# Growth in mass by river/area

```{r}
#| label: dataModelByRiverFlowOptions
#| include: false
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r}
#| label: librariesModelsFlowByRiver
#| echo: false

# for gams
library(gratia)
library(arm)
library(relaimpo)
library(GGally)
# library(linkedModels)
library(arrayhelpers)
library(mgcv)

library(getWBData)
library(lubridate)
library(kableExtra)
library(GGally)
library(lme4)
library(targets)
library(relaimpo)
library(caret)
library(pscl)
library(gridExtra)

library(getPrepareWBData) # for theme_publication()
library(ggthemes)

library(viridis)
library(tidyverse)

`%notin%` <- Negate(`%in%`)

source('./R/generalFunctions.R') #to get global_labeller_WB
```

```{r}
#| label: labellerModelsFlowByRiver
#| echo: false
# labelsIntSeason <- c(
#   "1" = "Spring",
#   "2" = "Summer",
#   "3" = "Autumn",
#   "4" = "Winter"
# )
# 
# labelsIntRiver <- c(
#   "west brook" = "West Brook",
#   "wb jimmy" = "Open Large",
#   "wb mitchell" = "Open Small",
#   "wb obear" = "Isolated Small"
# )
# 
# global_labellerInt <- labeller(
#   season = labelsIntSeason,
#   river = labelsIntRiver
#   #.default = label_both
# )
```

Read in fish and environmental data
```{r}
#| label: getDataGam
#| cache: false

library(targets) #Seems to be needed with cache: false

cd1 <- tar_read(cd1_target)  # from modelGrowthInMass_target
dGAM <- tar_read(dGAM_target) # from modelGrowthInMass_target

kIn = 4
speciesIn <- "Brook trout"

envData <- tar_read(envDataWB_target)
```

## Growth models  
### Flow duration curve data  

```{r}
#| label: fdc_growthByRiver

plotFDC_GR_byRiver <- function(d, r){
  fig1 <- ggplot(d |> filter(riverGG == r), aes(propBelowLoFlowThreshByRiverRiver, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se = FALSE) +
    #geom_smooth(se = FALSE) +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2)) +
    labs(x = "Proportion of high flow days", y = "Growth in mass") +
    scale_color_discrete() +
    ggtitle("Flow by river") +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
  
  fig2 <- ggplot(d |> filter(riverGG == r), aes(propAboveHiFlowThreshByRiverRiver, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se = FALSE) +
    #geom_smooth(se = FALSE) +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2)) +
    labs(x = "Proportion of low flow days", y = "Growth in mass") +
    scale_color_discrete() +
    ggtitle("Flow by river") +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
  
  grid.arrange(fig1, fig2, ncol = 2)
}

plotFDC_GR_byArea <- function(d, r){
  fig1 <- ggplot(d |> filter(riverGG == r), aes(propBelowLoFlowThreshByRiverArea_flowExt, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se = FALSE) +
    #geom_smooth(se = FALSE) +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2)) +
    labs(x = "Proportion of high flow days", y = "Growth in mass") +
    scale_color_discrete() +
    ggtitle("Flow by area") +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
  
  fig2 <- ggplot(d |> filter(riverGG == r), aes(propAboveHiFlowThreshByRiverArea_flowExt, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se = FALSE) +
    #geom_smooth(se = FALSE) +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2)) +
    labs(x = "Proportion of low flow days", y = "Growth in mass") +
    scale_color_discrete() +
    ggtitle("Flow by area") +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
  
  grid.arrange(fig1, fig2, ncol = 2)
}


plotFlowGR_byRiverOverlay <- function(d, r){
  ggplot(d |> filter(riverGG == r), aes(meanFlowByRiver, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2), color = "grey3") +
    
    geom_point(alpha = 0.05, color = "green4", aes(meanFlowByArea_flowExt, grWeight))  +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2), color = "green4", aes(meanFlowByArea_flowExt, grWeight)) +
    
    labs(x = "Mean flow by river (black = byRiver, green = byArea)", y = "Growth in mass") +
    scale_color_discrete() +
    #ggtitle(r) +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
}

```

::: panel-tabset
#### West Brook
```{r}
#| label: fdc_growthByRiver_wb

plotFDC_GR_byRiver(dGAM, "West Brook")
plotFDC_GR_byArea(dGAM, "West Brook")
```

#### Open Large
```{r}
#| label: fdc_growthByRiver_ol

plotFDC_GR_byRiver(dGAM, "Open Large")
plotFDC_GR_byArea(dGAM, "Open Large")
```

#### Open Small
```{r}
#| label: fdc_growthByRiver_os

plotFDC_GR_byRiver(dGAM, "Open Small")
plotFDC_GR_byArea(dGAM, "Open Small")
```

#### Isolated small
```{r}
#| label: fdc_growthByRiver_is

plotFDC_GR_byRiver(dGAM, "Isolated Small")
plotFDC_GR_byArea(dGAM, "Isolated Small")
```
:::

#### Flow compared with flow duration curve metrics
```{r}
#| label: fdcBelow_meanFlow
#| fig-cap: "By river in black and by area in green"
#| 
 ggplot(dGAM, aes(flowByRiverS, propBelowLoFlowThreshByRiver)) +
   geom_point() +
   geom_point(aes(flowByRiverS, propBelowLoFlowThreshByArea_flowExt), color  = "green4") +
   facet_grid(seasonGG ~ riverGG, scales = "free")
```

```{r}
#| label: fdcAbove_meanFlow
#| fig-cap: "By river in black and by area in green"

 ggplot(dGAM, aes(flowByRiverS, propAboveHiFlowThreshByRiver)) +
   geom_point() +
   geom_point(aes(flowByRiverS, propAboveHiFlowThreshByArea_flowExt), color  = "green4") +
   facet_grid(seasonGG ~ riverGG, scales = "free")
```




### Flow standardized by season
#### Environment/growth raw data graphs
```{r}
#| label: growthEnvRaw


```

```{r}
#| label: flow_growthByRiver

plotFlowGR_byRiver <- function(d, r){
  fig1 <- ggplot(d |> filter(riverGG == r), aes(meanFlowByRiver, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se = FALSE) +
    #geom_smooth(se = FALSE) +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2)) +
    labs(x = "Mean flow by river", y = "Growth in mass") +
    scale_color_discrete() +
    #ggtitle(r) +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
  
  fig2 <- ggplot(d |> filter(riverGG == r), aes(meanFlowByArea_flowExt, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se = FALSE) +
    #geom_smooth(se = FALSE) +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2)) +
    labs(x = "Mean flow by area", y = "Growth in mass") +
    scale_color_discrete() +
    #ggtitle(r) +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
  
  grid.arrange(fig1, fig2, ncol = 2)
}

plotFlowGR_byRiverOverlay <- function(d, r){
  ggplot(d |> filter(riverGG == r), aes(meanFlowByRiver, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2), color = "grey3") +
    
    geom_point(alpha = 0.05, color = "green4", aes(meanFlowByArea_flowExt, grWeight))  +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2), color = "green4", aes(meanFlowByArea_flowExt, grWeight)) +
    
    labs(x = "Mean flow by river", y = "Growth in mass") +
    scale_color_discrete() +
    #ggtitle(r) +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
}

```

::: panel-tabset
#### West Brook
```{r}
#| label: flow_growthByRiver_wb

plotFlowGR_byRiver(dGAM, "West Brook")
plotFlowGR_byRiverOverlay(dGAM, "West Brook")
```

#### Open Large
```{r}
#| label: flow_growthByRiver_ol

plotFlowGR_byRiver(dGAM, "Open Large")
plotFlowGR_byRiverOverlay(dGAM, "Open Large")
```

#### Open Small
```{r}
#| label: flow_growthByRiver_os

plotFlowGR_byRiver(dGAM, "Open Small")
plotFlowGR_byRiverOverlay(dGAM, "Open Small")
```

#### Isolated small
```{r}
#| label: flow_growthByRiver_is

plotFlowGR_byRiver(dGAM, "Isolated Small")
plotFlowGR_byRiverOverlay(dGAM, "Isolated Small")
```
:::


#### Brook trout - flow

```{r}
#| label: gamSModsBKT2

gamS0 <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowS)^2 + cohortF * ageF +             
               s(flowS, bs = "cr", k = kIn, by = riverGG) +
               s(flowS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

gamS1 <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowS)^2 + cohortF +             
               s(flowS, bs = "cr", k = kIn, by = riverGG) +
               s(flowS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# age matters, what about taking out length?
gamS2 <- bam(grWeight ~ (riverGG + seasonGG  + tempS + flowS)^2 + cohortF * ageF +             
               s(flowS, bs = "cr", k = kIn, by = riverGG) +
               s(flowS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

#nope, need to keep length
#How about without the interactions?
gamS3 <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowS) + cohortF * ageF +             
               s(flowS, bs = "cr", k = kIn, by = riverGG) +
               s(flowS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")
#nope, need the interactions

AIC(gamS0, gamS1, gamS2, gamS3) |> arrange(AIC)
```

#### Brook trout - flow by river

```{r}
#| label: gamSModsBKTFBR2

gamS1ByRiver <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowByRiverS)^2 + cohortF +             
               s(flowByRiverS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# age matters, what about taking out length?
gamS2ByRiver <- bam(grWeight ~ (riverGG + seasonGG  + tempS + flowByRiverS)^2 + cohortF +             
               s(flowByRiverS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

#nope, need to keep length
#How about without the interactions?
gamS3ByRiver <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowByRiverS) + cohortF +             
               s(flowByRiverS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")
#nope, need the interactions

#####
# add in lo flow thresh
gamS4ByRiver <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowByRiverS + 
                                propBelowLoFlowThreshByRiver)^2 + cohortF +             
               s(flowByRiverS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# add in high flow thresh
gamS5ByRiver <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowByRiverS + 
                                propAboveHiFlowThreshByRiver)^2 + cohortF +             
               s(flowByRiverS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# both lo and high flow thresh
gamS6ByRiver <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowByRiverS + 
                                propBelowLoFlowThreshByRiver + propAboveHiFlowThreshByRiver)^2 + cohortF +             
               s(flowByRiverS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# take out flow
gamS7ByRiver <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS +  
                                propBelowLoFlowThreshByRiver + propAboveHiFlowThreshByRiver)^2 + cohortF +             
               s(flowByRiverS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

AIC(gamS1ByRiver, gamS2ByRiver, gamS3ByRiver, gamS4ByRiver, 
    gamS5ByRiver, gamS6ByRiver, gamS7ByRiver) |> arrange(AIC)
```

#### Brook trout - flow by area

```{r}
#| label: gamSModsBKTFBA2

gamS1ByArea <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowByAreaS)^2 + cohortF +             
               s(flowByAreaS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# age matters, what about taking out length?
gamS2ByArea <- bam(grWeight ~ (riverGG + seasonGG  + tempS + flowByAreaS)^2 + cohortF +             
               s(flowByAreaS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

#nope, need to keep length
#How about without the interactions?
gamS3ByArea <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowByAreaS) + cohortF +             
               s(flowByAreaS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")
#nope, need the interactions

#####
# add in lo flow thresh
gamS4ByArea <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowByAreaS + 
                               propBelowLoFlowThreshByArea_flowExt)^2 + cohortF +             
               s(flowByAreaS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# add in high flow thresh
gamS5ByArea <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowByAreaS + 
                               propAboveHiFlowThreshByArea_flowExt)^2 + cohortF +             
               s(flowByAreaS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# both lo and high flow thresh
gamS6ByArea <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS + flowByAreaS + 
                               propBelowLoFlowThreshByArea_flowExt + propAboveHiFlowThreshByArea_flowExt)^2 + cohortF +             
               s(flowByAreaS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# take out flow
gamS7ByArea <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempS +  
                               propBelowLoFlowThreshByArea_flowExt + propAboveHiFlowThreshByArea_flowExt)^2 + cohortF +             
               s(flowByAreaS, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaS, bs = "cr", k = kIn, by = seasonGG) +
               s(tempS, bs = "cr", k = kIn, by = riverGG) +
               s(tempS, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

AIC(gamS1ByArea, gamS2ByArea, gamS3ByArea, gamS4ByArea, 
    gamS5ByArea, gamS6ByArea, gamS7ByArea) |> arrange(AIC)

```



#### Brook trout - compare flow and flow by river gams

```{r}
#| label: gamModsCompare2

predictBKTgamS <- function(dIn, modInFlowByRiver, modInFlowByArea){

  predMatByRiver0 <- 
    expand.grid(
      flowByRiverS = seq(-1.5, 1.5, 0.5), 
      propBelowLoFlowThreshByRiver = seq(0, 0.8, 0.2),
      propAboveHiFlowThreshByRiver = seq(0, 0.6, 0.2),
      tempS = seq(-1.5, 1.5, 0.55), 
      riverGG = unique(dIn$riverGG), 
      seasonGG= unique(dIn$seasonGG),
      observedWeight = c(2, 30, 60), #seq(2, max(dIn$observedWeight, na.rm = TRUE)/2, 20),
      cohortF = 2000:2013,#uunique(dIn$cohortF),
      byRiver = TRUE
  )
  
  predMatByRiver <- 
    add_column(
      pred = predict.bam(modInFlowByRiver, predMatByRiver0),
      predMatByRiver0
    ) |> 
    rename(flow = flowByRiverS, temp = tempS,
           loFlowThresh = propBelowLoFlowThreshByRiver, hiFlowThresh = propAboveHiFlowThreshByRiver)
  
  predMatByArea0 <- 
    expand.grid(
      flowByAreaS = seq(-1.5, 1.5, 0.5),
      propBelowLoFlowThreshByArea_flowExt = seq(0, 0.8, 0.2),
      propAboveHiFlowThreshByArea_flowExt = seq(0, 0.6, 0.2),
      tempS = seq(-1.5, 1.5, 0.5), 
      riverGG = unique(dIn$riverGG), 
      seasonGG= unique(dIn$seasonGG),
      observedWeight = c(2, 30, 60), #seq(2, max(dIn$observedWeight, na.rm = TRUE)/2, 20),
      cohortF = 2000:2013,#unique(dIn$cohortF),
      byRiver = FALSE
    ) 
  predMatByArea <- 
    add_column(
      pred = predict.bam(modInFlowByArea, predMatByArea0),
      predMatByArea0
    ) |> 
    rename(flow = flowByAreaS, temp = tempS,
           loFlowThresh = propBelowLoFlowThreshByArea_flowExt, hiFlowThresh = propAboveHiFlowThreshByArea_flowExt)

  return(add_row(predMatByRiver, predMatByArea))
}
gamSBKTPredictions <- predictBKTgamS(dGAM, gamS6ByRiver, gamS6ByArea)

```

#### Graph predictions   
Across cohorts, small fish
```{r}
#| label: graphGAMPredictionsByRiverSmallFish

ggplot(
  gamSBKTPredictions |> 
    filter(
      observedWeight %in% c(2),
      loFlowThresh == 0,
      hiFlowThresh == 0
      #cohortF == 2012, 
    ), 
  aes(temp, pred, color = (flow), group = (flow))) +
  geom_point(alpha = 0.2) +
  labs(x = "Stream temperature", y = "Predicted growth rate") +
  ylim(-0.02, 0.06) +
  #geom_smooth(se = FALSE) +
  geom_hline(yintercept = 0) +
  facet_grid(seasonGG ~ riverGG + byRiver, scales = 'free')
```

Across cohorts, large fish
```{r}
#| label: graphGAMPredictionsByRiverBigFish

ggplot(
  gamSBKTPredictions |> 
    filter(
      observedWeight %in% c(122), 
      #cohortF == 2012, 
      ageF == 0
    ), 
  aes(temp, pred, color = (flow), group = (flow))) +
  geom_point(alpha = 0.2) +
  labs(x = "Stream temperature", y = "Predicted growth rate") +
  ylim(-0.03, 0.04) +
  #geom_smooth(se = FALSE) +
  geom_hline(yintercept = 0) +
  facet_grid(seasonGG ~ riverGG + byRiver, scales = 'free')
```


### Flow std by season/river

```{r}
#| label: flow_growthByRiverSR

plotFlowGR_SR_byRiver <- function(d, r){
  fig1 <- ggplot(d |> filter(riverGG == r), aes(flowByRiverSR, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se = FALSE) +
    geom_smooth(se = FALSE) +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2)) +
    labs(x = "Mean flow by river", y = "Growth in mass") +
    scale_color_discrete() +
    #ggtitle(r) +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
  
  fig2 <- ggplot(d |> filter(riverGG == r), aes(flowByAreaSR, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se = FALSE) +
    geom_smooth(se = FALSE) +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2)) +
    labs(x = "Mean flow by area", y = "Growth in mass") +
    scale_color_discrete() +
    #ggtitle(r) +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
  
  grid.arrange(fig1, fig2, ncol = 2)
}

plotFlowGR_SR_byRiverOverlay <- function(d, r){
  ggplot(d |> filter(riverGG == r), aes(flowByRiverSR, grWeight)) +
    geom_point(alpha = 0.05)  +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2), color = "grey3") +
    
    geom_point(alpha = 0.05, color = "green4", aes(flowByAreaSR, grWeight))  +
    geom_smooth(method = "lm", se =FALSE, formula = y~poly(x,2), color = "green4", aes(flowByAreaSR, grWeight)) +
    
    labs(x = "Mean flow by river", y = "Growth in mass") +
    scale_color_discrete() +
    #ggtitle(r) +
    facet_grid(seasonGG~speciesGG)#, scales = 'free')
}

```

::: panel-tabset
#### West Brook
```{r}
#| label: flow_growthByRiverSR_wb

plotFlowGR_SR_byRiver(dGAM, "West Brook")
plotFlowGR_SR_byRiverOverlay(dGAM, "West Brook")
```

#### Open Large
```{r}
#| label: flow_growthByRiverSR_ol

plotFlowGR_SR_byRiver(dGAM, "Open Large")
plotFlowGR_SR_byRiverOverlay(dGAM, "Open Large")
```

#### Open Small
```{r}
#| label: flow_growthByRiverSR_os

plotFlowGR_SR_byRiver(dGAM, "Open Small")
plotFlowGR_SR_byRiverOverlay(dGAM, "Open Small")
```

#### Isolated small
```{r}
#| label: flow_growthByRiverSR_is

plotFlowGR_SR_byRiver(dGAM, "Isolated Small")
plotFlowGR_SR_byRiverOverlay(dGAM, "Isolated Small")
```
:::


#### Brook trout - flow
use scale(temperature) instead of tempSR?
```{r}
#| label: gamModsBKT2
kIn = 4
speciesIn <- "Brook trout"

gamSR0 <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempSR + flowSR)^2 + cohortF * ageF +             
               s(flowSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

gamSR1 <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempSR + flowSR)^2 + cohortF +             
               s(flowSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# age matters, what about taking out length?
gamSR2 <- bam(grWeight ~ (riverGG + seasonGG  + tempSR + flowSR)^2 + cohortF * ageF +             
               s(flowSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

#nope, need to keep length
#How about without the interactions?
gamSR3 <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempSR + flowSR) + cohortF * ageF +             
               s(flowSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")
#nope, need the interactions

AIC(gamSR0, gamSR1, gamSR2, gamSR3) |> arrange(AIC)
```

#### Brook trout - flow by river

```{r}
#| label: gamSRModsBKTFBR2

gamSR0ByRiver <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempSR + flowByRiverSR)^2 + cohortF * ageF +             
               s(flowByRiverSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

gamSR1ByRiver <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempSR + flowByRiverSR)^2 + cohortF +             
               s(flowByRiverSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# age matters, what about taking out length?
gamSR2ByRiver <- bam(grWeight ~ (riverGG + seasonGG  + tempSR + flowByRiverSR)^2 + cohortF * ageF +             
               s(flowByRiverSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

#nope, need to keep length
#How about without the interactions?
gamSR3ByRiver <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempSR + flowByRiverSR) + cohortF * ageF +             
               s(flowByRiverSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowByRiverSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")
#nope, need the interactions

AIC(gamSR0ByRiver, gamSR1ByRiver, gamSR2ByRiver, gamSR3ByRiver) |> arrange(AIC)
```

#### Brook trout - flow by area

```{r}
#| label: gamSRModsBKTFBA2

gamSR0ByArea <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempSR + flowByAreaSR)^2 + cohortF * ageF +             
               s(flowByAreaSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

gamSR1ByArea <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempSR + flowByAreaSR)^2 + cohortF +             
               s(flowByAreaSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

# age matters, what about taking out length?
gamSR2ByArea <- bam(grWeight ~ (riverGG + seasonGG  + tempSR + flowByAreaSR)^2 + cohortF * ageF +             
               s(flowByAreaSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")

#nope, need to keep length
#How about without the interactions?
gamSR3ByArea <- bam(grWeight ~ (riverGG + seasonGG + observedWeight + tempSR + flowByAreaSR) + cohortF * ageF +             
               s(flowByAreaSR, bs = "cr", k = kIn, by = riverGG) +
               s(flowByAreaSR, bs = "cr", k = kIn, by = seasonGG) +
               s(tempSR, bs = "cr", k = kIn, by = riverGG) +
               s(tempSR, bs = "cr", k = kIn, by = seasonGG),
             data = dGAM |> filter(speciesGG == speciesIn, cohort %in% 2000:2013), method = "REML")
#nope, need the interactions

AIC(gamSR0ByArea, gamSR1ByArea, gamSR2ByArea, gamSR3ByArea) |> arrange(AIC)
```


```{r}
#| label: gamSRModsCompareSR


predictBKTgamSR <- function(dIn, modInFlowByRiver, modInFlowByArea){

  predMatByRiver0 <- 
    expand.grid(
      flowByRiverSR = seq(-1.5,1.5,0.25), 
      tempSR = seq(-1.5,1.5,0.25), 
      riverGG = unique(dIn$riverGG), 
      seasonGG= unique(dIn$seasonGG),
      observedWeight = seq(2, max(dIn$observedWeight, na.rm = TRUE)/2, 20),
      cohortF = 2000:2013,#uunique(dIn$cohortF),
      ageF = 0:4,#unique(dIn$ageF),
      byRiver = TRUE
  )
  predMatByRiver <- 
    add_column(
      pred = predict.bam(modInFlowByRiver, predMatByRiver0),
      predMatByRiver0
    ) |> 
    rename(flow = flowByRiverSR, temp = tempSR)
  
  predMatByArea0 <- 
    expand.grid(
      flowByAreaSR = seq(-1.5,1.5,0.25), 
      tempSR = seq(-1.5,1.5,0.25), 
      riverGG = unique(dIn$riverGG), 
      seasonGG= unique(dIn$seasonGG),
      observedWeight = seq(2, max(dIn$observedWeight, na.rm = TRUE)/2, 20),
      cohortF = 2000:2013,#unique(dIn$cohortF),
      ageF = 0:4,#unique(dIn$ageF),
      byRiver = FALSE
    ) 
  predMatByArea <- 
    add_column(
      pred = predict.bam(modInFlowByArea, predMatByArea0),
      predMatByArea0
    ) |> 
    rename(flow = flowByAreaSR, temp = tempSR)

  return(add_row(predMatByRiver, predMatByArea))
}
gamSR_BKTPredictions <- predictBKTgamSR(dGAM, gamSR0ByRiver, gamSR0ByArea)


```

#### Graph predictions   
Across cohorts, small fish
```{r}
#| label: graphGAMSRPredictionsByRiverSmallFish

ggplot(
  gamSR_BKTPredictions |> 
    filter(
      observedWeight %in% c(22), 
      #cohortF == 2012, 
      ageF == 0
    ), 
  aes(temp, pred, color = (flow), group = (flow))) +
  geom_point(alpha = 0.2) +
  labs(x = "Stream temperature", y = "Predicted growth rate") +
  ylim(-0.005, 0.02) +
  #geom_smooth(se = FALSE) +
  geom_hline(yintercept = 0) +
  facet_grid(seasonGG ~ riverGG + byRiver, scales = 'free')
```

Across cohorts, large fish
```{r}
#| label: graphGAMSRPredictionsByRiverBigFish

ggplot(
  gamSR_BKTPredictions |> 
    filter(
      observedWeight %in% c(122), 
      #cohortF == 2012, 
      ageF == 0
    ), 
  aes(temp, pred, color = (flow), group = (flow))) +
  geom_point(alpha = 0.2) +
  labs(x = "Stream temperature", y = "Predicted growth rate") +
  ylim(-0.02, 0.02) +
  #geom_smooth(se = FALSE) +
  geom_hline(yintercept = 0) +
  facet_grid(seasonGG ~ riverGG + byRiver, scales = 'free')
```
